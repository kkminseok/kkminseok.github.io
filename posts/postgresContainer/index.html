<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="TestPostGresContainer Python 컨테이너 이름 바꾸기" /><meta name="author" content="minseok" /><meta property="og:locale" content="ko" /><meta name="description" content="사이드 프로젝트중.." /><meta property="og:description" content="사이드 프로젝트중.." /><link rel="canonical" href="https://kkminseok.github.io/posts/postgresContainer/" /><meta property="og:url" content="https://kkminseok.github.io/posts/postgresContainer/" /><meta property="og:site_name" content="민석강" /><meta property="og:image" content="https://kkminseok.github.io/assets/img/zinsap/containerName.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-16T02:00:00+09:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://kkminseok.github.io/assets/img/zinsap/containerName.png" /><meta property="twitter:title" content="TestPostGresContainer Python 컨테이너 이름 바꾸기" /><meta name="twitter:site" content="@none" /><meta name="twitter:creator" content="@minseok" /><meta name="google-site-verification" content="_icgy_j24DLYroQvKYTiffcqemP7ldWCxmrM2cGtYck" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"minseok"},"dateModified":"2022-08-16T17:43:11+09:00","datePublished":"2022-08-16T02:00:00+09:00","description":"사이드 프로젝트중..","headline":"TestPostGresContainer Python 컨테이너 이름 바꾸기","image":"https://kkminseok.github.io/assets/img/zinsap/containerName.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://kkminseok.github.io/posts/postgresContainer/"},"url":"https://kkminseok.github.io/posts/postgresContainer/"}</script><title>TestPostGresContainer Python 컨테이너 이름 바꾸기 | 민석강</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="민석강"><meta name="application-name" content="민석강"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sample/logo.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">민석강</a></div><div class="site-subtitle font-italic">3년차 개발자. 40살에 100억벌고 은퇴</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/kkminseok" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/none" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['minseok19950727','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>TestPostGresContainer Python 컨테이너 이름 바꾸기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>TestPostGresContainer Python 컨테이너 이름 바꾸기</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/kkminseok">minseok</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1660582800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-08-16 </em> </span> <span> Updated <em class="timeago" data-ts="1660639391" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-08-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1832 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p>사이드 프로젝트중..</p><p>진귀한 장면을 발견했다.</p><p><img data-src="/assets/img/zinsap/containerName.png" alt="" data-proofer-ignore></p><p>컨테이너 이름이 무작위로 막 생성되어있었다.</p><p>사실 몇개는 이미 컨테이너가 띄워진 상태로 돌아가고 있어서 다 꺼버렸다.</p><p>원인을 찾던중..</p><p>도커로 Postgres를 띄우는 코드는 사이드프로젝트 통합테스트 코드밖에 없다고 생각하여 코드를 뜯어봤다.</p><p>오픈소스로 제공하는 <code class="language-plaintext highlighter-rouge">testcontainers.postgres</code>를 Python언어로 사용하고 있었는데, 분명 이 속에서 Docker Container의 이름을 지정하는 곳이 있을거라 생각했다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PostgresTestContainer</span><span class="p">(</span><span class="n">PostgresContainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_connection_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># windows docker connection
</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">get_connection_url</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">'localnpipe'</span><span class="p">,</span> <span class="s">'localhost'</span><span class="p">)</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s">"session"</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">db_container</span><span class="p">(</span><span class="n">session_mocker</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">PostgresTestContainer</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="s">"postgres:9.5"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5432</span><span class="p">)</span> <span class="k">as</span> <span class="n">postgres</span><span class="p">:</span>
        <span class="p">...</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">PostgresTestContainer</code>클래스는 <code class="language-plaintext highlighter-rouge">PostgresContainer</code>를 상속받고 있길래 <code class="language-plaintext highlighter-rouge">PostgresContainer</code>요 코드로 들어가봤다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="c1">#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.
</span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">testcontainers.core.generic</span> <span class="kn">import</span> <span class="n">DbContainer</span>


<span class="k">class</span> <span class="nc">PostgresContainer</span><span class="p">(</span><span class="n">DbContainer</span><span class="p">):</span>
    <span class="s">"""
    Postgres database container.

    Example
    -------
    The example spins up a Postgres database and connects to it using the :code:`psycopg` driver.
    ::

        with PostgresContainer("postgres:9.5") as postgres:
            e = sqlalchemy.create_engine(postgres.get_connection_url())
            result = e.execute("select version()")
    """</span>
    <span class="n">POSTGRES_USER</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"POSTGRES_USER"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
    <span class="n">POSTGRES_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"POSTGRES_PASSWORD"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
    <span class="n">POSTGRES_DB</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"POSTGRES_DB"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">image</span><span class="o">=</span><span class="s">"postgres:latest"</span><span class="p">,</span>
                 <span class="n">port</span><span class="o">=</span><span class="mi">5432</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">dbname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">driver</span><span class="o">=</span><span class="s">"psycopg2"</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PostgresContainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_USER</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_USER</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_PASSWORD</span> <span class="o">=</span> <span class="n">password</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_PASSWORD</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_DB</span> <span class="o">=</span> <span class="n">dbname</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_DB</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">port_to_expose</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">with_exposed_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">port_to_expose</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">with_env</span><span class="p">(</span><span class="s">"POSTGRES_USER"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_USER</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">with_env</span><span class="p">(</span><span class="s">"POSTGRES_PASSWORD"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_PASSWORD</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">with_env</span><span class="p">(</span><span class="s">"POSTGRES_DB"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_DB</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_connection_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">_create_connection_url</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s">"postgresql+{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">driver</span><span class="p">),</span>
                                              <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_USER</span><span class="p">,</span>
                                              <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_PASSWORD</span><span class="p">,</span>
                                              <span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">POSTGRES_DB</span><span class="p">,</span>
                                              <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                              <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">port_to_expose</span><span class="p">)</span>

</pre></table></code></div></div><p>이 클래스는 <code class="language-plaintext highlighter-rouge">DbContainer</code>를 상속받고 있고, 컨테이너 이름을 설정하지는 않는것 같다. 부모 클래스로 들어가봐야겠다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre><td class="rouge-code"><pre><span class="c1">#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.
</span>
<span class="kn">from</span> <span class="nn">testcontainers.core.container</span> <span class="kn">import</span> <span class="n">DockerContainer</span>
<span class="kn">from</span> <span class="nn">testcontainers.core.waiting_utils</span> <span class="kn">import</span> <span class="n">wait_container_is_ready</span>
<span class="kn">from</span> <span class="nn">deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="n">ADDITIONAL_TRANSIENT_ERRORS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">DBAPIError</span>
    <span class="n">ADDITIONAL_TRANSIENT_ERRORS</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">DBAPIError</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">DbContainer</span><span class="p">(</span><span class="n">DockerContainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DbContainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="o">@</span><span class="n">wait_container_is_ready</span><span class="p">(</span><span class="o">*</span><span class="n">ADDITIONAL_TRANSIENT_ERRORS</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sqlalchemy</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="p">.</span><span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_connection_url</span><span class="p">())</span>
        <span class="n">engine</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_connection_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_create_connection_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                               <span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">"container has not been started"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_container_host_ip</span><span class="p">()</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_exposed_port</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"{dialect}://{username}:{password}@{host}:{port}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">db_name</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">db_name</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_configure</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>


<span class="k">class</span> <span class="nc">GenericContainer</span><span class="p">(</span><span class="n">DockerContainer</span><span class="p">):</span>
    <span class="o">@</span><span class="n">deprecated</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="s">"Use `DockerContainer`."</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GenericContainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

</pre></table></code></div></div><p>이 클래스도 컨테이너의 이름을 설정하지는 않는다. <code class="language-plaintext highlighter-rouge">DockerContainer</code>를 상속받으므로 저 코드로 또 들어가봐야겠다.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">docker.models.containers</span> <span class="kn">import</span> <span class="n">Container</span>

<span class="kn">from</span> <span class="nn">testcontainers.core.docker_client</span> <span class="kn">import</span> <span class="n">DockerClient</span>
<span class="kn">from</span> <span class="nn">testcontainers.core.exceptions</span> <span class="kn">import</span> <span class="n">ContainerStartException</span>
<span class="kn">from</span> <span class="nn">testcontainers.core.utils</span> <span class="kn">import</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">inside_container</span><span class="p">,</span> <span class="n">is_arm</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DockerContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">docker_client_kw</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ports</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_docker</span> <span class="o">=</span> <span class="n">DockerClient</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">docker_client_kw</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_container</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_command</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">with_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">with_bind_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="n">host</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">container</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">with_exposed_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="o">@</span><span class="n">deprecated</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="s">'Use `with_kwargs`.'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">with_kargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">with_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">with_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">maybe_emulate_amd64</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_arm</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">with_kwargs</span><span class="p">(</span><span class="n">platform</span><span class="o">=</span><span class="s">'linux/amd64'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Pulling image %s"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">image</span><span class="p">)</span>
        <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">docker_client</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">image</span><span class="p">,</span>
                                            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_command</span><span class="p">,</span>
                                            <span class="n">detach</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                            <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span>
                                            <span class="n">ports</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ports</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_name</span><span class="p">,</span>
                                            <span class="n">volumes</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">volumes</span><span class="p">,</span>
                                            <span class="o">**</span><span class="bp">self</span><span class="p">.</span><span class="n">_kwargs</span>
                                            <span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Container started: %s"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="n">short_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delete_volume</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">get_wrapped_container</span><span class="p">().</span><span class="n">remove</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">delete_volume</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Try to remove the container in all circumstances
        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722
</span>                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_container_host_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># infer from docker host
</span>        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">().</span><span class="n">host</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"localhost"</span>

        <span class="c1"># check testcontainers itself runs inside docker container
</span>        <span class="k">if</span> <span class="n">inside_container</span><span class="p">():</span>
            <span class="c1"># If newly spawned container's gateway IP address from the docker
</span>            <span class="c1"># "bridge" network is equal to detected host address, we should use
</span>            <span class="c1"># container IP address, otherwise fall back to detected host
</span>            <span class="c1"># address. Even it's inside container, we need to double check,
</span>            <span class="c1"># because docker host might be set to docker:dind, usually in CI/CD environment
</span>            <span class="n">gateway_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">().</span><span class="n">gateway_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gateway_ip</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">().</span><span class="n">bridge_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gateway_ip</span>
        <span class="k">return</span> <span class="n">host</span>

    <span class="k">def</span> <span class="nf">get_exposed_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">mapped_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">().</span><span class="n">port</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inside_container</span><span class="p">():</span>
            <span class="n">gateway_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">().</span><span class="n">gateway_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_docker_client</span><span class="p">().</span><span class="n">host</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">gateway_ip</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">port</span>
        <span class="k">return</span> <span class="n">mapped_port</span>

    <span class="k">def</span> <span class="nf">with_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">with_volume_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'ro'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'DockerContainer'</span><span class="p">:</span>
        <span class="c1"># '/home/user1/': {'bind': '/mnt/vol2', 'mode': 'rw'}
</span>        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">'bind'</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span> <span class="s">'mode'</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">volumes</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_wrapped_container</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Container</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span>

    <span class="k">def</span> <span class="nf">get_docker_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DockerClient</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_docker</span>

    <span class="k">def</span> <span class="nf">get_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ContainerStartException</span><span class="p">(</span><span class="s">"Container should be started before"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="n">logs</span><span class="p">(</span><span class="n">stderr</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">.</span><span class="n">logs</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_container</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ContainerStartException</span><span class="p">(</span><span class="s">"Container should be started before"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_wrapped_container</span><span class="p">().</span><span class="n">exec_run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

</pre></table></code></div></div><p>여기서 보아하니 이름을 설정하는 곳을 찾은것 같다 <code class="language-plaintext highlighter-rouge">__init__</code>에서 초기화 작업을 해주고 있다.</p><p>확장성을 고려하여 <code class="language-plaintext highlighter-rouge">None</code>도 받아야한다. <code class="language-plaintext highlighter-rouge">None</code>을 받으면 컨테이너 이름을 랜덤으로 만들어서 띄우는데 이게 쌓이다보니 맨 위의 스크린샷이 된다.</p><p>그래서</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DockerContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">docker_client_kw</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="p">...</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
    
</pre></table></code></div></div><p>처럼 <code class="language-plaintext highlighter-rouge">name=None</code>을 추가하고 <code class="language-plaintext highlighter-rouge">self._name = name</code>구문으로 초기화해주었다.</p><p>그리고 다시 통합테스트 코드로 가서</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PostgresTestContainer</span><span class="p">(</span><span class="n">PostgresContainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_connection_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># windows docker connection
</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">().</span><span class="n">get_connection_url</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">'localnpipe'</span><span class="p">,</span> <span class="s">'localhost'</span><span class="p">)</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s">"session"</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">db_container</span><span class="p">(</span><span class="n">session_mocker</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">PostgresTestContainer</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="s">"postgres:9.5"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5432</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"ZinsaContainer"</span><span class="p">)</span> <span class="k">as</span> <span class="n">postgres</span><span class="p">:</span>
        <span class="p">...</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">name</code>을 추가하여 통합테스트를 실행해보았다.</p><p><img data-src="/assets/img/zinsap/containerName2.png" alt="" data-proofer-ignore></p><p>성공했다.</p><p>혹시몰라 인자에서 <code class="language-plaintext highlighter-rouge">name</code>을 빼보고 실행해보았다.</p><p><img data-src="/assets/img/zinsap/containerName3.png" alt="" data-proofer-ignore></p><p>랜덤한 이름으로 컨테이너를 잘 띄운다.</p><hr /><h2 id="후기"><span class="mr-2">후기</span><a href="#후기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>이걸 OCP라고하면 OCP일까? 기능을 확장시켰고 기존 요건인 None도 받을 수 있게 하였으니..</p><p>다만 걱정스러운건 이 소스를 제공한 사람들이 일부러 <code class="language-plaintext highlighter-rouge">name</code>을 인자로 받지 못하게 설계한것이 아닐까? 충돌의 위험이 있을까?</p><p>잘 모르겠다. 컨테이너가 계속 쌓이는것이 불편해서 하나의 이름을 가진 컨테이너로 띄웠다 내렸다 하고 싶은 마음에 시도해보았다.</p><p>앞으로 부딪히다보면 이 방법의 단점을 알 수도 있을 것 같다.</p><p>팀원들아 프로젝트 진행좀 해줘</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/python/'>Python</a>, <a href='/categories/fastapi/'>FastAPI</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/fastapi/" class="post-tag no-text-decoration" >FastAPI</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=TestPostGresContainer Python 컨테이너 이름 바꾸기 - 민석강&amp;url=https://kkminseok.github.io/posts/postgresContainer/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=TestPostGresContainer Python 컨테이너 이름 바꾸기 - 민석강&amp;u=https://kkminseok.github.io/posts/postgresContainer/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://kkminseok.github.io/posts/postgresContainer/&amp;text=TestPostGresContainer Python 컨테이너 이름 바꾸기 - 민석강" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/2023-03-06-dnd/">DND 8기 활동 후기</a><li><a href="/posts/2024-03-31-fastapi/">fastapi Swagger Response 분리하기</a><li><a href="/posts/2023-05-19-think01/">5월19일시점 개발하면서 고민한 것들 + 도커관련 이슈</a><li><a href="/posts/2023-05-02-Modern-Java-In-action/">2번 읽는 Modern Java In Action - Chapter06 스트림으로 데이터 수집</a><li><a href="/posts/2023-03-18-Modern-Java-In-Action/">2번 읽는 Modern Java In Action - Chapter01 기초</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/leetcode/">leetcode</a> <a class="post-tag" href="/tags/programmers/">Programmers</a> <a class="post-tag" href="/tags/baekjoon/">Baekjoon</a> <a class="post-tag" href="/tags/algorithmstudy/">AlgorithmStudy</a> <a class="post-tag" href="/tags/top100like/">Top100Like</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/fastapi/">FastAPI</a> <a class="post-tag" href="/tags/economy/">Economy</a> <a class="post-tag" href="/tags/dp/">DP</a> <a class="post-tag" href="/tags/top100interview/">Top100Interview</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/fastapi01/"><div class="card-body"> <em class="timeago small" data-ts="1652198400" > 2022-05-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FastAPI 공식문서 따라하기[1] - FastAPI</h3><div class="text-muted small"><p> https://fastapi.tiangolo.com/ko/ 공식문서 따라하는 글 1. FastAPI의 특징 빠르다. 개발속도 증가 버그가 적다. 자동완성 기능, 적은 디버깅 시간, 직관적 쉽다 코드 중복을 최소화시켜 짧다. 견고하다. 표준기반 2. 요구사항 Python3.6+ Starlette, ...</p></div></div></a></div><div class="card"> <a href="/posts/fastapi02/"><div class="card-body"> <em class="timeago small" data-ts="1652202000" > 2022-05-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FastAPI 공식문서 따라하기[2] - 첫걸음</h3><div class="text-muted small"><p> https://fastapi.tiangolo.com/ko/ 공식문서 따라하는 글 ☑️ 1. 기초 # main.py from fastapi import FastAPI app = FastAPI() @app.get(&quot;/&quot;) def read_root() : return {&quot;Im&quot; : &quot;kms first_step!!&quot;} $ uvico...</p></div></div></a></div><div class="card"> <a href="/posts/fastapi03/"><div class="card-body"> <em class="timeago small" data-ts="1652205600" > 2022-05-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FastAPI 공식문서 따라하기[3] - 경로 매개변수</h3><div class="text-muted small"><p> https://fastapi.tiangolo.com/ko/ 공식문서 따라하는 글 ☑️ 1. 경로 매개변수 매개변수를 경로안에 선언할 수 있다. SpringMVC와 비슷한 문법 #main.py from fastapi import FastAPI kmsapp = FastAPI() @kmsapp.get(&quot;/computers/{compu...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/baekjoon15990/" class="btn btn-outline-primary" prompt="Older"><p>Baekjoon15990 - 1,2,3 더하기5(Python)</p></a> <a href="/posts/baekjoon16194/" class="btn btn-outline-primary" prompt="Newer"><p>Baekjoon16194 - 카드 구매하기 2(Python)</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "kkminseok/kkminseok.github.io", "data-repo-id": "MDEwOlJlcG9zaXRvcnkzNDUwNzI2OTM=", "data-category": "Announcements", "data-category-id": "DIC_kwDOFJFkNc4CO5-J", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/none">kang minseok</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/leetcode/">leetcode</a> <a class="post-tag" href="/tags/programmers/">Programmers</a> <a class="post-tag" href="/tags/baekjoon/">Baekjoon</a> <a class="post-tag" href="/tags/algorithmstudy/">AlgorithmStudy</a> <a class="post-tag" href="/tags/top100like/">Top100Like</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/fastapi/">FastAPI</a> <a class="post-tag" href="/tags/economy/">Economy</a> <a class="post-tag" href="/tags/dp/">DP</a> <a class="post-tag" href="/tags/top100interview/">Top100Interview</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-KMXXJ0D586"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-KMXXJ0D586'); }); </script>
