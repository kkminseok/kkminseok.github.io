---
title: real-worldí”„ë¡œì íŠ¸ Spring ì‹œì‘í•˜ê¸°(8) - íšŒì›ê°€ì…API ë° Jwt Token ë§Œë“¤ê¸°(2)
author: 
    name: minseok
    link: https://github.com/kkminseok
date: 2022-12-08 00:02:00 +0800
categories: [Toy,real-world-spring]
tags: [Spring]
math: true
mermaid: true
image: 
    path: /assets/img/realworld/realworldLogo.png
comments: true
---

> [real-world project êµ¬í˜„ ê³¼ì • ì¹´í…Œê³ ë¦¬ ë³´ê¸°](https://kkminseok.github.io/categories/real-world-spring/)
{: .prompt-info}

ì´ë²ˆì—ëŠ” í† í°ì„ ë§Œë“¤ì–´ë³´ê³ , ì‘ë‹µê°’ì„ ì¡°ë¦½í•˜ì—¬ ì‘ë‹µì„ í•´ë³¼ ê²ƒì´ë‹¤.

ì €ë²ˆì—ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì™€ DTOë¥¼ êµ¬í˜„í–ˆìœ¼ë¯€ë¡œ, ì„œë¹„ìŠ¤ê³„ì¸µì„ êµ¬í˜„í•´ì•¼í•œë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ ServiceëŠ” êµ¬í˜„ì²´ì™€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‚˜ëˆˆë‹¤.

ê·¸ ì´ìœ ë¡œëŠ” ë‹¤í˜•ì„±ì„ ìœ„í•¨ì´ ìˆë‹¤. í•˜ì§€ë§Œ 1ëŒ€1ë¡œ ë§¤í•‘ë˜ì–´ìˆëŠ” ê²½ìš°ì—ëŠ” êµ³ì´ í•  í•„ìš”ê°€ ì—†ì§€ë§Œ í™•ì¥ì„±ì„ ê³ ë ¤í•´ì„œ í•˜ë©´ ì¢‹ê³  í˜‘ì—…ì‹œ ì½”ë“œ ìœ ì§€ë³´ìˆ˜ì—ë„ ì¢‹ìœ¼ë‹ˆê¹Œ í•˜ëŠ”ê²Œ ì¢‹ë‹¤.

```java
package com.io.realworld.domain.aggregate.user.service;

import com.io.realworld.domain.aggregate.user.dto.*;

public interface UserService {
    UserResponse signup(UserSignupRequest userSignupRequest);
}
```

ë”°ë¼ì„œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ë ‡ê²Œ ë”°ë¡œ ë‘ê³ 

## ğŸ‘ UserServiceImpl

```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl {

    private final UserRepository userRepository;

    private final PasswordEncoder passwordEncoder;

    private final JwtService jwtService;

    public UserResponse signup(UserSignupRequest userSignupRequest) {
        User findEmail = userRepository.findByEmail(userSignupRequest.getEmail());
        Optional<User> findUsername = userRepository.findByUsername(userSignupRequest.getUsername());

        if ( findEmail != null &&  !findUsername.isEmpty()) {
            throw new CustomException(Error.DUPLICATE_EMAIL_USERNAME);
        }else if(findEmail != null){
            throw new CustomException(Error.DUPLICATE_EMAIL);
        }else if(!findUsername.isEmpty()){
            throw new CustomException(Error.DUPLICATE_USERNAME);
        }
        else {
            return convertUser(userRepository.save(User.builder().
                            username(userSignupRequest.getUsername()).
                            email(userSignupRequest.getEmail()).
                            password(madeHash(userSignupRequest.getPassword())).
                            image("https://api.realworld.io/images/smiley-cyrus.jpeg").build()));
        }
    }

    private String madeHash(String password) {
        return passwordEncoder.encode(password);
    }

    private UserResponse convertUser(User user){
        return UserResponse.builder().username(user.getUsername())
                .email(user.getEmail())
                .bio(user.getBio())
                .image(user.getImage())
                .token(jwtService.createToken(user.getEmail()))
                .build();
    }
}
```

êµ¬í˜„ì²´ë¥¼ ë§Œë“ ë‹¤.

ì•„ì§ ë§Œë“¤ì§€ ì•Šì€ Repository, passwordEncoder, jwtServiceëŠ” ìŠê³  ìœ„ì—ì„œ ë¶€í„° ì°¨ê·¼íˆ ë¦¬ë·°í•˜ê² ë‹¤.

- `@Service`: Serviceì–´ë…¸í…Œì´ì…˜ì€ ë¶€íŠ¸ê°€ ìµœì´ˆì— ëœ°ë•Œ ìŠ¤ìº”í•˜ì—¬ ë¹ˆì— ë“±ë¡í•˜ë¼ëŠ” ëœ»ì´ë‹¤. 
- `@RequiredArgsConstructor`: ì´ ì–´ë…¸í…Œì´ì…˜ì€ `final`ì´ë‚˜ `@NotNull`ì´ ë¶™ì€ í•„ë“œì˜ ìƒì„±ìë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ëŠ” ë¡¬ë³µ ì–´ë…¸í…Œì´ì…˜ì´ë‹¤. (ìƒì„±ì ì£¼ì…) ì»¨íƒìŠ¤íŠ¸ì— ë“±ë¡ëœ ì—¬ëŸ¬ ë¹ˆ(repository, jwtService, passwordencoder)ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë„£ì–´ì¤˜ì•¼í•œë‹¤.


ë¡œì§ì€ ê°„ë‹¨í•˜ë‹¤.
- ë“¤ì–´ì˜¨ Emailì„ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì¡°íšŒí•˜ì—¬ Email ì¤‘ë³µì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. ì¤‘ë³µì´ë¼ë©´ `throw new CustomException(Error.DUPLICATE_EMAIL);`ë¡œ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
- ë§ˆì°¬ê°€ì§€ë¡œ UserNameë„ ì¡°íšŒí•˜ì—¬ ì¤‘ë³µê°’ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. ë§Œì•½ ì¤‘ë³µì´ë¼ë©´ `throw new CustomException(Error.DUPLICATE_USERNAME);` ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

ê³µí†µ ì˜ˆì™¸ì²˜ë¦¬ëŠ” ë‹¤ìŒì— ì•Œì•„ë³´ê³  ì¼ë‹¨ ì €ëŸ° ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤ëŠ”ê²ƒë§Œ ì´ ê¸€ì— ì ê² ë‹¤.

ì¤‘ë³µ ì²˜ë¦¬ê°€ ëë‚¬ë‹¤ë©´ ê·¸ëŒ€ë¡œ ë“¤ì–´ì˜¨ ê°ì²´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•´ì£¼ë©´ëœë‹¤.

```java
userRepository.save(User.builder().
                            username(userSignupRequest.getUsername()).
                            email(userSignupRequest.getEmail()).
                            password(madeHash(userSignupRequest.getPassword())).
                            image("https://api.realworld.io/images/smiley-cyrus.jpeg").build()
```
ìœ ì €ë¥¼ ì €ì¥í•˜ëŠ”ë¶€ë¶„ì¸ë° save()í•¨ìˆ˜ëŠ” ë¦¬í„´ê°’ì„ ë”°ë¡œ ì§€ì •í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ JPAë¥¼ ìƒì†ë°›ì„ë•Œ ì§€ì •í•œ ì—”í‹°í‹° ì˜¤ë¸Œì íŠ¸ ìœ í˜•ìœ¼ë¡œ ë¦¬í„´í•œë‹¤. ì´ëŠ” `User`ê°ì²´ì´ê³  ìš°ë¦¬ëŠ” passwordê°€ í¬í•¨ëœ `User`ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‘ë‹µê°’ìœ¼ë¡œ ë„˜ê¸°ë©´ ì•ˆë˜ë¯€ë¡œ `convertUser()`í•¨ìˆ˜ë¡œ í†µí•´ ì‘ë‹µ ê°ì²´ë¥¼ ë§ì¶°ì¤˜ì•¼í•œë‹¤.

ê·¸ë¦¬ê³  `madeHash()`í•¨ìˆ˜ì— `PasswordEncoder`ë¥¼ í†µí•´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•œë‹¤.

## ğŸ‘ PassowordEncder ?

ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì œê³µí•˜ëŠ” ì•”í˜¸í™”í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë‹¤.

ì´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € Beanì— ë“±ë¡í•´ì¤˜ì•¼í•˜ëŠ”ë°, ì•ì— [í¬ìŠ¤íŒ…](https://kkminseok.github.io/posts/realworld05/)ì—ì„œ ë“±ë¡í•´ì¤¬ë‹¤. ê·¸ê²ƒë„ `BCryptPasswordEncoder`ë¼ëŠ” í´ë˜ìŠ¤ ìœ í˜•ìœ¼ë¡œ ë§ì´ë‹¤.

`BCryptPasswordEncoder`ëŠ” ê¸°ë³¸ ì•”í˜¸ í•´ì‹œí•¨ìˆ˜ë¥¼ í†µí•´ ì•”í˜¸í™”í•˜ëŠ” êµ¬í˜„ì²´ë‹¤. ì‹œíë¦¬í‹°ì—ì„œ ì œê³µí•˜ëŠ” `PasswordEncoder`ì˜ ë¬¸ì„œë¥¼ ë³´ë©´ ì´ êµ¬í˜„ì²´ë¥¼ ì„ í˜¸í•œë‹¤ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

```text
//Doc
Service interface for encoding passwords. The preferred implementation is BCryptPasswordEncoder.
```

ë¹„í¬ë¦½íŠ¸ ì¸ì½”ë”ì— ë‹¤ë£¨ëŠ”ê±´ ì¢€ ë” ê¹Šì€ ë‚´ìš©ì´ ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¹„í¬ë¦½íŠ¸ë¼ëŠ” ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•œë‹¤ëŠ”ê±¸ ì•Œì•„ë‘ë©´ ë  ê²ƒ ê°™ë‹¤.

## ğŸ‘ UserRepository

JPAë¥¼ ì‚¬ìš©í•´ì„œ êµ¬í˜„í•˜ë©´ ëœë‹¤. ì•„ì§ `save()`ë§ê³ ëŠ” êµ¬í˜„í•  ê²Œ ì—†ë‹¤.

`save()`ì˜ ë¦¬í„´ê°’ì„ ì§ì ‘ëª…ì‹œí•´ì¤˜ë„ ë˜ì§€ë§Œ ë‚˜ëŠ” ëª…ì‹œí•˜ì§€ ì•Šì•˜ë‹¤. 

```java
public interface UserRepository extends JpaRepository<User, Long> {
}
```

ê¸°ë³¸ì œê³µë˜ëŠ” `save()`í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ê²ƒì´ê³  ë¦¬í„´ê°’ì€ Jpaì œë„ˆë¦­ìœ¼ë¡œ ì§€ì •í•œ ì²«ë²ˆì§¸ ê°’ `User`ê°ì²´ê°€ ë  ê²ƒì´ë‹¤.

ë‹¤ì‹œ Serviceí•¨ìˆ˜ë¡œ ëŒì•„ê°€ì„œ save()ì˜ ë¦¬í„´ì„ ë°›ì•˜ë‹¤ ì¹˜ê³  ì´ë¥¼ real-worldì—ì„œ ìš”êµ¬í•˜ëŠ” ë¦¬í„´ ê°ì²´ë¡œ ë§ì¶°ì¤˜ì•¼í•œë‹¤.

## ğŸ‘ UserSingup Response DTO ë§Œë“¤ê¸°

```java
@Builder
@Getter
@JsonTypeName("user")
@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, include = JsonTypeInfo.As.WRAPPER_OBJECT)
public class UserResponse {

    private String email;
    private String token;
    private String username;
    private String bio;
    private String image;
}

```

Request DTOë¥¼ ë§Œë“¤ë©´ì„œ ì–´ë…¸í…Œì´ì…˜ì— ëŒ€í•œ ì„¤ëª…ì„ í–ˆìœ¼ë¯€ë¡œ ë”°ë¡œ ë¦¬ë·°í• ê±´ ì—†ë‹¤. ì£¼ëª©ì ì€ **password**ê°€ í¬í•¨ë˜ì–´ìˆì§€ ì•Šê³  **token**ì„ ë¦¬í„´í•œë‹¤ëŠ” ê²ƒì´ë‹¤.

## ğŸ‘ JwtService ë§Œë“¤ê¸°

`convertUser()`í•¨ìˆ˜ ì•ˆì— ìˆëŠ” `jwtService.createToken(user.getEmail())`ë¥¼ ë¦¬ë·°í•´ì•¼í•œë‹¤.

JwtService í´ë˜ìŠ¤ëŠ” ë‹¤ìŒì²˜ëŸ¼ êµ¬í˜„í–ˆë‹¤.

```java
@Service
@AllArgsConstructor
public class JwtService {

    private final JwtConfig jwtConfig;

    private Key getSignKey(String secretKey){
        byte[] keyBytes = secretKey.getBytes(StandardCharsets.UTF_8);
        return Keys.hmacShaKeyFor(keyBytes);
    }

    public String createToken(String email){
        Claims claims = Jwts.claims();
        claims.put("email",email);
        
        return Jwts.builder()
                .setClaims(claims)
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + jwtConfig.getExpiry() * 1000))
                .signWith(getSignKey(jwtConfig.getKey()))
                .compact();
    }
}
```

> Jwt ì¸ì¦, ë°ì´í„° íŒŒì‹± ë¶€ë¶„ì€ ëºìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ì´ ì½”ë“œë§Œ ë³´ë©´ ë  ê²ƒ ê°™ì•„ì„œì…ë‹ˆë‹¤.
{: .prompt-info}

ë¨¼ì € ì„œë¹„ìŠ¤ì—ì„œ í˜¸ì¶œí•˜ëŠ” `createToken()`ì„ ë´ì•¼í•œë‹¤.

`Claims`ê°ì²´ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ”ë° **Jwt ë° Claims**ì— ëŒ€í•´ì„œëŠ” [ì´ ê¸€](https://kkminseok.github.io/posts/realworld06/)ì—ì„œ ì„¤ëª…í–ˆë‹¤.

jwtì— í•„ìš”í•œ issue, expiryì„ ì§€ì •í•˜ê³  signWith()ëŠ” ë‘ë²ˆì§¸ ì¸ìë¥¼ í†µí•´ ì•”í˜¸í™” ë°©ì‹ë„ ì§€ì •í•´ì¤€ë‹¤.
ì´ ì½”ë“œì— signWith()ëŠ” ë‘ë²ˆì§¸ ì¸ìê°’ì´ ì—†ì–´ì„œ ì•”í˜¸í™” ë°©ì‹ì´ ì—†ëŠ”ë°, ì´ë„ ë°›ëŠ”ë‹¤. ë‹¤ë§Œ ì•”í˜¸í™” ë°©ì‹ì„ í†µí•´ ì•”í˜¸í™”ëœ ê°’ì„ ì¸ìë¡œ ë°›ê¸¸ ì›í•œë‹¤.

```java
    /**
     * ~~~~
     * recommended signature algorithm isn't sufficient for your needs, consider using
     * {@link #signWith(Key, SignatureAlgorithm)} instead.
     * ~~~~~
     */
    JwtBuilder signWith(Key key) throws InvalidKeyException;
```

í•˜ì§€ë§Œ `getSignKey()` í•¨ìˆ˜ì˜ ë¦¬í„´ê°’ì„ ë³´ë©´ `Keys.hmacShaKeyFor()`ë¥¼ í†µí•´ ì•”í˜¸í™”í•´ì¤¬ë‹¤ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤. `hmacShaKeyFor()`í•¨ìˆ˜ëŠ” HMAC-SHA ì•”í˜¸ ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ì„œ ë“¤ì–´ì˜¨ ê°’ì„ ì•”í˜¸í™” ì‹œì¼œë²„ë¦°ë‹¤.

ì½”ë“œì—ì„œëŠ” claimsì— emailê°’ì„ ì§‘ì–´ë„£ì—ˆëŠ”ë°, ì´ëŠ” ì˜ ì„ íƒí•´ì•¼í•œë‹¤. ê°œì¸ì •ë³´ë¥¼ ìµœëŒ€í•œ ë‹´ì•„ë†“ì§€ ì•Šì•„ì•¼í•œë‹¤. ë¯¼ê°í•œ ì •ë³´ë¥¼ ì €ì¥í•´ ë†“ìœ¼ë©´ í† í°ì„ íƒˆì·¨ë‹¹í–ˆì„ëŒ€ í”¼í•´ê°€ ë” í´ ìœ„í—˜ì´ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

`compact()`í•¨ìˆ˜ëŠ” Jwtí† í°ì„ ë¹Œë”íŒ¨í„´ì„ í†µí•´ ìƒì„±í•˜ê³ , **ì§ë ¬í™”**í•˜ì—¬ ì™¸ë¶€ì—ì„œë„ ì“°ì¼ ìˆ˜ ìˆê²Œ í•œë‹¤.

ë˜í•œ, ì´ ì½”ë“œì— ë³´ë©´ `jwtConfig`ì´ë¼ëŠ”ê²Œ ë‚˜ì˜¤ëŠ”ë°, ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ì‹œì¼œë†¨ë‹¤.

## ğŸ‘ JwtConfig.class

```java
@Component
@Getter
@PropertySource("classpath:application.properties")
public class JwtConfig {

    @Value("${real-world.token.expiry}")
    private Long expiry;

    @Value("${real-world.token.key}")
    private String key;
}
```

`@PropertySource`ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ `application.properties`ì— ì €ì¥ë˜ì–´ìˆëŠ” í™˜ê²½ë³€ìˆ˜ ê°’ë“¤ì„ ê°€ì ¸ì˜¨ë‹¤. 

ë‚˜ ê°™ì€ ê²½ìš°

```text
real-world.token.expiry=3000000
real-world.token.key=rea12312412412SQL0132474654564564213131d31vfxvjfijkjdks
```

ì´ë ‡ê²Œ ì €ì¥í•´ë†¨ìœ¼ë©° ê°œë°œìì˜ ì…ë§›ì— ë”°ë¼ ë°”ê¾¸ë©´ëœë‹¤. expiryëŠ” í† í° ë§Œë£Œì‹œê°„, keyëŠ” ê°œë°œìê°€ ì •ì˜í•  ë¹„ë°€í‚¤ê°’ì´ë‹¤.

ì—¬ê¸°ê¹Œì§€ê°€ tokenì„ ìƒì„±í•˜ê³  ì‘ë‹µê°’ì„ ì§€ì •í•´ì¤€ê²ƒì´ë‹¤.

ì—¬ê¸°ê¹Œì§€ê°€ íšŒì›ê°€ì… ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤, ë ˆí¬ì§€í† ë¦¬ì˜ êµ¬í˜„ì´ë‹¤.

> ë§Œì•½ ì½”ë“œê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”. ì´ëŠ” ì „ì²´ì½”ë“œ ì¤‘ ë¦¬ë·°ì— í•„ìš”í•œ ë¶€ë¶„ë§Œ ì ˆì‚­í•˜ì—¬ ë³´ì—¬ì¤€ê²ƒì´ë¯€ë¡œ í•´ê²°í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
{: .prompt-info}


> í˜„ì¬ ì´ í”„ë¡œì íŠ¸ëŠ” vue.js + vite + vuex  + Spring boot, Spring Data JPA + Spring Security ë¥¼ ì´ìš©í•˜ì—¬ real-world ë°ëª¨ë²„ì „ì„ ì œì‘ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.  <https://github.com/kkminseok/real-world-springboot>
{: .prompt-tip}





