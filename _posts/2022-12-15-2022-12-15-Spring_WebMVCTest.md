---
title: SpringMVC - MockMvc, @WebMvcTestì½”ë“œê¹Œë³´ê¸°
author: 
    name: minseok
    link: https://github.com/kkminseok
date: 2022-12-15 01:02:00 +0800
categories: [Java, Spring]
tags: [Java]
math: true
mermaid: true
image: 
    path: 
comments: true
---

> [real-world project êµ¬í˜„ ê³¼ì • ì¹´í…Œê³ ë¦¬ ë³´ê¸°](https://kkminseok.github.io/categories/real-world-spring/)
{: .prompt-info}


# ê°œìš”

í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì§œë©´ì„œ ì–´ì©Œë‹¤ë³´ë‹ˆ ì“°ê³  ìˆëŠ” ì´ í´ë˜ìŠ¤, ì–´ë…¸í…Œì´ì…˜ë“¤ ì •ë¦¬í•  í•„ìš”ë¥¼ ëŠê¼ˆë‹¤.

## ğŸ˜ MockMvc, @WebMvcTest

`@WebMvcTest`ì–´ë…¸í…Œì´ì…˜ì„ ì•Œê¸° ì „ `MockMvc`ì— ëŒ€í•´ ì•Œê³  ìˆì–´ì•¼í•œë‹¤. `@WebMvcTest` ë¬¸ì„œë¥¼ ë³´ë©´ `MockMvc`ì— ëŒ€í•œ ì–¸ê¸‰ì´ ë‚˜ì˜¤ê¸° ë•Œë¬¸ì´ë‹¤.

```java
@WebMvcTest(controllers = UsersController.class)
class UsersControllerTest {

    void signup(UserSignupRequest userSignupRequest) throws Exception {
        @Autowired
        MockMvc mockMvc;

        ...
        //when , then
        mockMvc.perform(post("/api/users")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(userSignupRequest))
                        .with(csrf())
                )

        ...
    }

    ...
}
```

ì´ëŸ°ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ìˆëŠ” mockMvc

mockMvcëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì— ê°€ì§œ HTTPìš”ì²­ì„ ë³´ë‚¸ë‹¤.

Springì€ `DispatcherServlet`ì´ë¼ëŠ” ì‹¤ì œ ì›¹ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¸”ë¦¿ì„ ê°€ì§€ê³  ìˆëŠ”ë° mockMvcëŠ” `DispatcherServlet`ì„ ëª¨ë°©í•˜ì—¬ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.

ì´ëŸ¬í•œ ê°€ì§œ ì„œë¸”ë¦¿ì„ í†µí•´ ì‹¤ì œ ì›¹ ì„œë²„ê°€ ëœ¨ì§€ ì•Šê³ ë„ ì»¨íŠ¸ë¡¤ëŸ¬ì— ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆì–´ì„œ í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤.

ë‹¨ì ìœ¼ë¡œëŠ” ì‹¤ì œ ì›¹ ì„œë²„ì™€ ë‹¤ë¥´ê²Œ ë™ì‘í•  ìˆ˜ ìˆì–´ì„œ ì •í™•í•œ í…ŒìŠ¤íŠ¸ê°€ ì–´ë ¤ìš¸ ìˆ˜ë„ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

ì£½ mockMvcëŠ”

1. ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ê´€ë ¨ëœ ì •ë³´ë¥¼ ê°€ì§€ê³  ê°€ì§œ HTTP ìš”ì²­ ìƒì„±ì„ í•œë‹¤.
2. ê°€ì§œ HTTP ìš”ì²­ì„ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì „ë‹¬í•œë‹¤. ì´ ìš”ì²­ì€ `DispatcherServlet`ì„ ëª¨ë°©í•œ ë°©ì‹ëŒ€ë¡œ ì²˜ë¦¬ë¨. ìš”ì²­í•œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì°¾ê³ , ìš”ì²­ì„ ì „ë‹¬í•œë‹¤.
3. ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì‘ë‹µì„ ê²€ì¦í•œë‹¤. ì´ëŠ” `.andExpect()`ê°™ì€ í•¨ìˆ˜ë¥¼ í†µí•´ ê²€ì¦ì´ ê°€ëŠ¥í•˜ë‹¤.

ê·¸ëŸ¬ë©´ MockMvcëŠ” ì–´ë–»ê²Œ ê°€ì§œ servletì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ê±¸ê¹Œ?

ê·¸ëŸ¬ë©´ ë‹¤ì‹œ `@WebMvcTest`ì— ëŒ€í•´ ê°„ë‹¨íˆ ì–¸ê¸‰í•´ì•¼í•œë‹¤.

ì´ëŠ” `@SpringBootApplication`ê°€ ìë™ì„¤ì •ì„ ë„ì™€ì£¼ë“¯ í•´ë‹¹ ì–´ë…¸í…Œì´ì…˜ë„ í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ì„¤ì •ë“¤ì„ ìë™í™”í•´ì¤€ë‹¤ê³  í˜„ì¬ëŠ” ì´í•´í•˜ì.

ì•„ë¬´íŠ¼ `@WebMvcTest` ì½”ë“œë¥¼ ë³´ë©´

```java
@Bean
@ConditionalOnMissingBean
public MockMvc mockMvc(MockMvcBuilder builder) {
    return builder.build();
}
```
> @ConditionalOnMissingBeanëŠ” ì´ë¯¸ ë“±ë¡ëœ ë¹ˆì´ ì—†ì„ë•Œ ìƒˆë¡œ ë§Œë“¤ì–´ì¤€ë‹¤ëŠ” ì½”ë“œ

ë¼ëŠ” ì½”ë“œê°€ ìˆë‹¤. ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì½”ë“œì´ë‹¤. íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ì˜¨ builderì—ëŠ” ì›¹ ì»¨í…ìŠ¤íŠ¸ì˜ ì •ë³´ê°€ ë“¤ì–´ìˆë‹¤ê³  ì•Œê³  ìˆì. 

ì•„ë¬´íŠ¼ MockMvc ë¹ˆì„ ìƒì„±í•  ë•Œ ë¹Œë”íŒ¨í„´ì„ í†µí•´ ë¹Œë“œë¥¼ í•˜ê²Œ ë˜ëŠ” ê²ƒ ê°™ë‹¤. ê·¸ë˜ì„œ í•´ë‹¹ ì½”ë“œë¡œ ë˜ ë“¤ì–´ê°€ë³´ë©´

```java
@Override
@SuppressWarnings("rawtypes")
public final MockMvc build() {
    WebApplicationContext wac = initWebAppContext();
    ServletContext servletContext = wac.getServletContext();
    MockServletConfig mockServletConfig = new MockServletConfig(servletContext);

    for (MockMvcConfigurer configurer : this.configurers) {
        RequestPostProcessor processor = configurer.beforeMockMvcCreated(this, wac);
        if (processor != null) {
            if (this.defaultRequestBuilder == null) {
                this.defaultRequestBuilder = MockMvcRequestBuilders.get("/");
            }
            if (this.defaultRequestBuilder instanceof ConfigurableSmartRequestBuilder) {
                ((ConfigurableSmartRequestBuilder) this.defaultRequestBuilder).with(processor);
            }
        }
    }

    Filter[] filterArray = this.filters.toArray(new Filter[0]);

    return super.createMockMvc(filterArray, mockServletConfig, wac, this.defaultRequestBuilder,
            this.defaultResponseCharacterEncoding, this.globalResultMatchers, this.globalResultHandlers,
            this.dispatcherServletCustomizers);
}
```

ìš”ì•½í•˜ìë©´ í…ŒìŠ¤íŠ¸ìš© ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ë°, ì´ì— ì €ì¥ëœ í•„í„°, ì„¤ì •ë“¤ì„ ì‹¤ì œ ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ì— ë„£ëŠ”ë‹¤.

ê·¸ë¦¬ê³  `createMockMvc()`ì„ ë¦¬í„´í•˜ê¸°ì— ì´ ì½”ë“œë„ ê¹Œë´ì•¼í•œë‹¤.

```java
protected final MockMvc createMockMvc(Filter[] filters, MockServletConfig servletConfig,
        WebApplicationContext webAppContext, @Nullable RequestBuilder defaultRequestBuilder,
        List<ResultMatcher> globalResultMatchers, List<ResultHandler> globalResultHandlers,
        @Nullable List<DispatcherServletCustomizer> dispatcherServletCustomizers) {

    TestDispatcherServlet dispatcherServlet = new TestDispatcherServlet(webAppContext);
    
    ...

    try {
        dispatcherServlet.init(servletConfig);
    }
    catch (ServletException ex) {
        // should never happen..
        throw new MockMvcBuildException("Failed to initialize TestDispatcherServlet", ex);
    }

    MockMvc mockMvc = new MockMvc(dispatcherServlet, filters);
    mockMvc.setDefaultRequest(defaultRequestBuilder);
    mockMvc.setGlobalResultMatchers(globalResultMatchers);
    mockMvc.setGlobalResultHandlers(globalResultHandlers);

    return mockMvc;
}
```

ë³´ì•„í•˜ë‹ˆ, í…ŒìŠ¤íŠ¸ìš© DispatcherServletì„ ë§Œë“¤ê³  MockMvcê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ë„£ëŠ”ë‹¤.

`new MockMvc(dispatcherServlet, filters)`ì„ ë³´ë©´

```java
MockMvc(TestDispatcherServlet servlet, Filter... filters) {
    Assert.notNull(servlet, "DispatcherServlet is required");
    Assert.notNull(filters, "Filters cannot be null");
    Assert.noNullElements(filters, "Filters cannot contain null values");

    this.servlet = servlet;
    this.filters = filters;
    this.servletContext = servlet.getServletContext();
}
```

ì´ë ‡ê²Œ ë˜ì–´ìˆë‹¤. ì¦‰, MockMvcëŠ” ë¹ˆì— ë“±ë¡ë˜ì–´ìˆê³ , í…ŒìŠ¤íŠ¸ìš© `DispatcherServlet`ê³¼ ì„¤ì •ê°’ë“¤ì„ ê°€ì§€ê³  ìˆë‹¤.

ê·¸ëŸ¬ë©´ ì‹¤ì œ MockMvcì¸ìŠ¤í„´ìŠ¤ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê³³ì„ ë³´ì.

```java
mockMvc.perform(post("/api/users")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(userSignupRequest))
                        .with(csrf())
                )
                .andExpect(MockMvcResultMatchers.status().isOk())
```

ì´ë ‡ê²Œ êµ¬í˜„í•´ë†¨ëŠ”ë°, `.perform()`ì€ ì–´ë–»ê²Œ ìˆ˜í–‰ë˜ëŠ”ê±¸ê¹Œ??

```java
public ResultActions perform(RequestBuilder requestBuilder) throws Exception {

        ...

        //1. í…ŒìŠ¤íŠ¸ìš© HttpServletRequest ê°ì²´ì— ê°’ì„ ë„£ìŒ.
		MockHttpServletRequest request = requestBuilder.buildRequest(this.servletContext);

        //2. ë¹„ë™ê¸° ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ í˜¸ì¶œ => null
		AsyncContext asyncContext = request.getAsyncContext();
		MockHttpServletResponse mockResponse;
		HttpServletResponse servletResponse;
		if (asyncContext != null) {
            ...
		}
        //3. nullì´ë¯€ë¡œ ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ìš© HttpServletResponse ê°ì²´ë¥¼ ë§Œë“¦. ì´ë•ŒëŠ” ë¹ˆ ê°’ì´ë‹¤. statusë„ 200ì´ê³  responseì˜ ë‚´ìš©ë¬¼ì€ ë¹„ì–´ìˆë‹¤.
		else {
			mockResponse = new MockHttpServletResponse();
			servletResponse = mockResponse;
		}

		
        //4. ì¸í’‹ í—¤ë”ë¥¼ ê²€ì¦í•˜ëŠ” ë¶€ë¶„ê°™ì€ë° ì˜ ì´í•´ ëª»í–ˆìŠµë‹ˆë‹¤.
		if (requestBuilder instanceof SmartRequestBuilder) {
			request = ((SmartRequestBuilder) requestBuilder).postProcessRequest(request);
		}

        //5. mvcResultëŠ” mockRequest,ì™€ mockResponseë¥¼ ê°€ì§€ê³  ìˆë‹¤.
		MvcResult mvcResult = new DefaultMvcResult(request, mockResponse);
        //6. ë¦¬í€˜ìŠ¤íŠ¸ ì†ì„±ì— ì´ê°’ì„ í‚¤-ê°’ í˜•íƒœë¡œ ë„£ëŠ”ë‹¤.
		request.setAttribute(MVC_RESULT_ATTRIBUTE, mvcResult);

        ...

		
        //7. í…ŒìŠ¤íŠ¸ìš© í•„í„°ë¥¼ ìƒì„±í•˜ëŠ”ë°, ì´ ê°’ì—ëŠ” ê¸°ë³¸ í•„í„°ë“¤ê³¼ ì‚¬ìš©ìê°€ ì •ì˜í•œ í•„í„°(Jwt ê´€ë ¨)ê°€ ë“¤ì–´ìˆë‹¤. ë˜í•œ ì¸ìë¡œ ë“¤ì–´ê°„ í…ŒìŠ¤íŠ¸ìš© ì„œë¸”ë¦¿ê°ì²´ë„ ë“¤ì–´ê°€ ìˆë‹¤.
		MockFilterChain filterChain = new MockFilterChain(this.servlet, this.filters);
        //8. ì‹¤ì§ˆì ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¶€ë¶„ì´ë‹¤. ë“¤ì–´ì˜¨ í•„í„°ë¥¼ ë„ëŠ”ë° ê²°êµ­ ë§ˆì§€ë§‰ì— ë“¤ì–´ê°„ ì„œë¸”ë¦¿ê°ì²´ì˜ service()ë„ í˜¸ì¶œí•˜ì—¬ ì‹¤ì§ˆì ìœ¼ë¡œ ê°€ì§œHTTPìš”ì²­ì´ MockMvcê°€ ë§Œë“  ì„œë¸”ë¦¿ê°ì²´ì— ë“¤ì–´ê°„ë‹¤.
		filterChain.doFilter(request, servletResponse);

        ...

        //9. ê²°êµ­ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ëŠ”ë‹¤.
		applyDefaultResultActions(mvcResult);
		RequestContextHolder.setRequestAttributes(previousAttributes);

        //10. andExpect()ì²˜ëŸ¼ í›„ì²˜ë¦¬.
		return new ResultActions() {
			@Override
			public ResultActions andExpect(ResultMatcher matcher) throws Exception {
				matcher.match(mvcResult);
				return this;
			}
			@Override
			public ResultActions andDo(ResultHandler handler) throws Exception {
				handler.handle(mvcResult);
				return this;
			}
			@Override
			public MvcResult andReturn() {
				return mvcResult;
			}
		};
	}
```

ì°¸ê³ ë¡œ

íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ì˜¨ `requestBuilder`ëŠ” ì´ëŸ°ì‹ìœ¼ë¡œ ì €ì¥ë˜ì–´ìˆë‹¤.

![image](https://user-images.githubusercontent.com/30401054/207798619-420c749c-0b0e-4438-93c8-efd8f2ecd121.png)

-----

ì“°ë‹¤ë§ë‹¤ ì“°ë‹¤ë§ë‹¤í•´ì„œ ë‚´ìš©ì´ ì¢€ ë‚œì¡í•˜ë‹¤. ì°¸ê³ ë§Œ í•´ì•¼í• ê²ƒ ê°™ë‹¤.